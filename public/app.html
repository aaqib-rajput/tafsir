<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tafsir Session Manager — V3 Ultra Pro</title>
<style>
:root{
  --primary:#4f46e5;
  --light-red:#fee2e2;
  --light-green:#dcfce7;
  --gray-300:#d1d5db;
  --gray-500:#6b7280;
  --bg:#f8fafc;
  font-family:Inter,system-ui,sans-serif;
}
*{box-sizing:border-box}
body{margin:0;min-height:100vh;background:linear-gradient(135deg,#eef2ff,#f8fafc);display:flex;justify-content:center;padding:2rem}
.app{width:min(1250px,96vw);display:grid;grid-template-columns:1fr 1fr;grid-template-rows:auto 1fr;gap:1.2rem}
.panel{background:white;border-radius:18px;padding:1.2rem;box-shadow:0 16px 30px rgba(0,0,0,0.08);display:flex;flex-direction:column}
h1{margin:0 0 .9rem;font-size:1.15rem}
.row{display:flex;gap:.5rem;margin-bottom:.6rem;align-items:center;flex-wrap:wrap}
input,select{flex:1;padding:.55rem .6rem;border-radius:8px;border:1px solid var(--gray-300);background:#fff;min-width:120px}
button{border:none;border-radius:8px;padding:.45rem .7rem;cursor:pointer;font-size:.84rem}
button:hover{opacity:.92}
.primary{background:var(--primary);color:#fff}
.present-btn{background:#dbeafe}
.speak-btn{background:#c7d2fe}
.absent-btn{background:#fecaca}
.remove-btn{background:#f3f4f6}
.control-btn{background:#e0e7ff}
.download-btn{background:#16a34a;color:#fff}
.timer{text-align:center;padding:1rem;border-radius:12px;background:#f3f4ff}
.timer-value{font-size:2.4rem;font-weight:700}
#speakerTimerValue{font-size:2.9rem;font-weight:800;color:var(--primary)}
.timer-meta{color:var(--gray-500);font-size:.9rem;margin-bottom:.5rem}
ul{list-style:none;padding:0;margin:0}
.scroll-box{overflow-y:auto;max-height:260px}
li{display:flex;justify-content:space-between;align-items:center;padding:.5rem;border-radius:10px;border:1px solid #e5e7eb;margin-bottom:.4rem;gap:10px}
li.present{background:var(--light-green)}
li.absent{background:var(--light-red)}
li.speaking{border:2px solid var(--primary)}
.small{font-size:.8rem;color:var(--gray-500)}
.badge{background:#eef2ff;border-radius:999px;padding:.2rem .55rem;font-size:.75rem}
.footer-panel{grid-column:1 / -1;background:#fff;border-radius:18px;padding:1rem 1.2rem;box-shadow:0 12px 24px rgba(0,0,0,.07)}
.footer-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.8rem}
.card{background:var(--bg);border:1px solid #e5e7eb;border-radius:14px;padding:.8rem}
.progress-wrap{margin-top:.5rem;background:#e5e7eb;border-radius:999px;height:10px;overflow:hidden}
.progress-bar{height:100%;width:0%;background:#4f46e5;transition:width .3s}
.flash{animation:flash 1s infinite}
@keyframes flash{0%,100%{background:#fee2e2}50%{background:#fecaca}}
.queue-item{display:inline-block;background:#eef2ff;border-radius:999px;padding:.2rem .5rem;margin:.15rem;font-size:.75rem}
.speaker-controls{margin-top:.75rem;background:var(--bg);border:1px solid #e5e7eb;border-radius:12px;padding:.75rem}
.speaker-controls .row:last-child{margin-bottom:0}
</style>
</head>
<body>
<main class="app">
  <section class="panel">
    <h1>Session Timer</h1>
    <div class="timer">
      <div class="row">
        <input id="sessionMinutes" type="number" min="1" placeholder="Minutes..." />
        <button id="startSession" class="primary">Start</button>
      </div>
      <p id="sessionTimer" class="timer-value">00:00</p>
    </div>
  </section>

  <section class="panel">
    <h1>Speaking Summary</h1>
    <button id="downloadCSV" class="download-btn" style="margin-bottom:10px">Download CSV</button>
    <div class="scroll-box"><ul id="summaryList"></ul></div>
  </section>

  <section class="panel">
    <h1>Attendance</h1>
    <div class="row" style="justify-content:space-between;font-weight:600">
      <span>Total: <span id="totalCount">0</span></span>
      <span style="color:green">Present: <span id="presentCount">0</span></span>
      <span style="color:red">Absent: <span id="absentCount">0</span></span>
    </div>
    <div class="row">
      <input id="nameInput" placeholder="Add new member..." />
      <button id="addBtn" class="primary">Add</button>
    </div>
    <div class="scroll-box"><ul id="attendanceList"></ul></div>
  </section>

  <section class="panel">
    <h1>Speaker Timer</h1>
    <div class="timer" id="speakerTimerCard">
      <p id="currentSpeaker" class="timer-meta">No one speaking</p>
      <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
      <p id="speakerTimerValue">02:00</p>
      <div class="row" style="justify-content:center;margin-top:.5rem">
        <button id="startSpeaker" class="control-btn">Start</button>
        <button id="pauseSpeaker" class="control-btn">Pause</button>
        <button id="resetSpeaker" class="control-btn">Reset</button>
      </div>
    </div>

    <div class="speaker-controls">
      <div class="small" style="margin-bottom:.4rem">Simple settings: Name, Role, Time</div>
      <div class="row">
        <select id="speakerSelect"></select>
      </div>
      <div class="row">
        <select id="roleSelect" style="max-width:180px">
          <option value="participant">Participant</option>
          <option value="presenter">Presenter</option>
          <option value="cohost">Co-host</option>
          <option value="host">Host</option>
        </select>
        <input id="customMinutes" type="number" min="1" placeholder="Minutes" style="max-width:120px" />
        <button id="updateSpeakerSettings" class="control-btn">Update</button>
      </div>
    </div>

    <div style="margin-top:.6rem" class="small">Queue:</div>
    <div id="queueBox" style="min-height:28px"></div>
  </section>

  <section class="footer-panel">
    <h1 style="margin-bottom:.7rem">Teams (Default Members)</h1>
    <div class="footer-grid" id="teamCards"></div>

    <div class="card" style="margin-top:.8rem">
      <strong>Role Manager</strong>
      <div class="small" style="margin:.35rem 0 .5rem">Set default role time used for new members.</div>
      <div class="row">
        <select id="roleConfigSelect" style="max-width:150px">
          <option value="participant">Participant</option>
          <option value="presenter">Presenter</option>
          <option value="cohost">Co-host</option>
          <option value="host">Host</option>
        </select>
        <input id="roleConfigMinutes" type="number" min="1" placeholder="Minutes" style="max-width:110px">
        <button id="saveRoleConfig" class="control-btn">Save Role Time</button>
      </div>
    </div>

    <div class="card" style="margin-top:.8rem">
      <strong>Session Team Control</strong>
      <div class="row" style="margin-top:.6rem">
        <select id="teamSessionSelect">
          <option value="ALL">ALL Teams</option>
          <option value="Team A">Team A</option>
          <option value="Team B">Team B</option>
          <option value="Team C">Team C</option>
        </select>
        <button id="applyTeamSession" class="control-btn">Load Team</button>
        <button id="resetDefaultSession" class="absent-btn">Reset Default</button>
      </div>
    </div>
  </section>
</main>

<script>
const TEAM_DATA = {
  "Team A": ["Nadeem","Zoya","Rohma Zil Arsh","Sameen Zara","Ahmad Adrees","Mubashir Ali","Ali Hanzala","Ammara","Noor Ayesha","Masaud Khan","Khushbakht Tausif Hashmi","Wasif","Romana Daim","Ahsan Raza","Amina Khan","Wania","Shahid Ameer Hamza","Afsana Yaqoob","Safa Shahid","Dr. Rimsha"],
  "Team B": ["Aqib","Khadija","Malaika Imran","Hasnat Fatima","Abdullah Shahbaz","Rimsha Kousar","Attaullah","Sidra Sahir","Maryam Iftikhar","Saleha","Huraima","Sidra Bashir","Usba","Shaheer","Zunaira Rashid","Bilal","Abdur Rehman Khan","Abdullah Chaudhry","Azhar Mehmood","Tahira","Nasseb Ullah","Fiza Urooj","Sadia Wajahat","Muhammad Ibrahim","Rabia Naqi","Zamurrad"],
  "Team C": ["Saboor","Kamran","Sidra Younas","Ishrat Fatima","Saddam Sharif","Faiza","Rehana","Talha Mushtaq","Azeem Aourangzaib","Mrs Azeem Aourangzaib","Muhammad Uzair Rashid","Fahad Khan","Arsalan G14","Arsalan G07","Majid Khan","Abdullah Khan","Kashif Noor","Zain ul Abideen","Farhan Afzal","Amna Fazahil","Bilal Shahid","Hina Yousuf"]
};

const DEFAULT_ROLE_LIMITS = { participant:120, presenter:180, cohost:300, host:600 };
let ROLE_LIMITS = { ...DEFAULT_ROLE_LIMITS };
let members = [];
let currentSpeakerId = null;
let speakerQueue = [];
let speakerInterval = null;
let speakerTime = 120;
let speakerInitial = 120;
let sessionInterval = null;
let sessionTime = 0;

const attendanceList = document.getElementById("attendanceList");
const summaryList = document.getElementById("summaryList");
const speakerTimerDisplay = document.getElementById("speakerTimerValue");
const currentSpeakerDisplay = document.getElementById("currentSpeaker");
const speakerSelect = document.getElementById("speakerSelect");
const roleSelect = document.getElementById("roleSelect");
const customMinutes = document.getElementById("customMinutes");

function format(sec){
  return String(Math.floor(sec/60)).padStart(2,"0") + ":" + String(sec%60).padStart(2,"0");
}

function saveState(){
  localStorage.setItem("tsm_v3_members", JSON.stringify(members));
}

function saveRoleConfig(){
  localStorage.setItem("tsm_v3_roles", JSON.stringify(ROLE_LIMITS));
}

function loadRoleConfig(){
  try {
    const saved = JSON.parse(localStorage.getItem("tsm_v3_roles") || "null");
    if(saved && typeof saved === "object"){
      ROLE_LIMITS = { ...ROLE_LIMITS, ...saved };
    }
  } catch(e){}
}

function refreshRoleLabels(){
  [...roleSelect.options].forEach((opt)=>{
    const role = opt.value;
    const mins = Math.round((ROLE_LIMITS[role] || 120) / 60);
    const label = role === "cohost" ? "Co-host" : role.charAt(0).toUpperCase() + role.slice(1);
    opt.textContent = `${label} (${mins}m)`;
  });
}

function updateProgress(){
  const pct = speakerInitial ? Math.max(0, Math.min(100, ((speakerInitial - speakerTime) / speakerInitial) * 100)) : 0;
  document.getElementById("progressBar").style.width = pct + "%";
  const card = document.getElementById("speakerTimerCard");
  if(currentSpeakerId && speakerTime <= 0) card.classList.add("flash");
  else card.classList.remove("flash");
}

function renderQueue(){
  const queueBox = document.getElementById("queueBox");
  queueBox.innerHTML = "";
  speakerQueue.forEach((id) => {
    const m = members.find((x)=>String(x.id) === String(id));
    if(!m) return;
    const item = document.createElement("span");
    item.className = "queue-item";
    item.textContent = m.name;
    queueBox.appendChild(item);
  });
}

function syncSpeakerControls(id){
  const selected = members.find((m)=>String(m.id) === String(id));
  if(!selected) return;
  speakerSelect.value = String(selected.id);
  roleSelect.value = selected.role || "participant";
  customMinutes.value = String(Math.max(1, Math.round((selected.speakLimit || 120) / 60)));
}

function setCurrentSpeaker(id){
  const m = members.find((x)=>String(x.id) === String(id));
  if(!m) return;
  currentSpeakerId = m.id;
  speakerTime = m.speakLimit;
  speakerInitial = m.speakLimit;
  currentSpeakerDisplay.textContent = `Current: ${m.name}`;
  speakerTimerDisplay.textContent = format(speakerTime);
  syncSpeakerControls(m.id);
  updateProgress();
}

function removeFromQueue(id){
  speakerQueue = speakerQueue.filter((x)=>String(x)!==String(id));
}

function startSpeakerTimer(){
  if(!currentSpeakerId) return;
  clearInterval(speakerInterval);
  speakerInterval = setInterval(()=>{
    speakerTime -= 1;
    const speaker = members.find((m)=>m.id === currentSpeakerId);
    if(speaker) speaker.time += 1;

    if(speakerTime <= 0){
      clearInterval(speakerInterval);
      if(speakerQueue.length){
        const nextId = speakerQueue.shift();
        setCurrentSpeaker(nextId);
        startSpeakerTimer();
      }
    }

    speakerTimerDisplay.textContent = format(Math.max(0, speakerTime));
    updateProgress();
    saveState();
    render();
  }, 1000);
}

function resetSpeaker(){
  clearInterval(speakerInterval);
  const speaker = members.find((m)=>m.id === currentSpeakerId);
  if(!speaker) return;
  speaker.time = 0;
  speakerTime = speaker.speakLimit;
  speakerInitial = speaker.speakLimit;
  speakerTimerDisplay.textContent = format(speakerTime);
  updateProgress();
  saveState();
  render();
}

function addMember(){
  const input = document.getElementById("nameInput");
  const name = input.value.trim();
  if(!name) return;
  members.push({
    id: Date.now() + Math.random(),
    name,
    attendance: "",
    time: 0,
    role: "participant",
    speakLimit: ROLE_LIMITS.participant
  });
  input.value = "";
  render();
}

function loadTeamSession(teamName){
  clearInterval(speakerInterval);
  currentSpeakerId = null;
  speakerQueue = [];
  members = [];

  const names = teamName === "ALL" ? Object.values(TEAM_DATA).flat() : (TEAM_DATA[teamName] || []);
  names.forEach((name)=>{
    members.push({
      id: Date.now() + Math.random(),
      name,
      attendance: "",
      time: 0,
      role: "participant",
      speakLimit: ROLE_LIMITS.participant
    });
  });

  speakerTime = 120;
  speakerInitial = 120;
  currentSpeakerDisplay.textContent = "No one speaking";
  speakerTimerDisplay.textContent = "02:00";
  render();
  updateProgress();
}

function renderTeamCards(){
  const wrap = document.getElementById("teamCards");
  wrap.innerHTML = "";
  Object.entries(TEAM_DATA).forEach(([team, list])=>{
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<strong>${team}</strong><div class="small" style="margin-top:.4rem">${list.join(", ")}</div>`;
    wrap.appendChild(card);
  });
}

function render(){
  attendanceList.innerHTML = "";
  summaryList.innerHTML = "";
  let present = 0;
  let absent = 0;

  speakerSelect.innerHTML = "";
  members.forEach((m)=>{
    const opt = document.createElement("option");
    opt.value = String(m.id);
    opt.textContent = `${m.name} (${format(m.speakLimit)})`;
    speakerSelect.appendChild(opt);

    const li = document.createElement("li");
    if(m.attendance === "present") { li.classList.add("present"); present++; }
    if(m.attendance === "absent") { li.classList.add("absent"); absent++; }
    if(m.id === currentSpeakerId) li.classList.add("speaking");

    const name = document.createElement("span");
    name.textContent = `${m.name} — ${m.role}`;

    const actions = document.createElement("div");
    actions.className = "row";
    actions.style.margin = "0";

    const presentBtn = document.createElement("button");
    presentBtn.className = "present-btn";
    presentBtn.textContent = "Present";
    presentBtn.onclick = ()=>{ m.attendance = "present"; render(); };

    const speakBtn = document.createElement("button");
    speakBtn.className = "speak-btn";
    speakBtn.textContent = "Speak";
    speakBtn.onclick = ()=>{
      if(!currentSpeakerId){
        setCurrentSpeaker(m.id);
      } else if(String(currentSpeakerId) !== String(m.id)){
        if(!speakerQueue.some((id)=>String(id)===String(m.id))){
          speakerQueue.push(m.id);
        }
      }
      syncSpeakerControls(m.id);
      renderQueue();
      render();
    };

    const absentBtn = document.createElement("button");
    absentBtn.className = "absent-btn";
    absentBtn.textContent = "Absent";
    absentBtn.onclick = ()=>{ m.attendance = "absent"; removeFromQueue(m.id); if(m.id===currentSpeakerId){ clearInterval(speakerInterval); currentSpeakerId=null; currentSpeakerDisplay.textContent="No one speaking";} render(); };

    const removeBtn = document.createElement("button");
    removeBtn.className = "remove-btn";
    removeBtn.textContent = "Remove";
    removeBtn.onclick = ()=>{
      removeFromQueue(m.id);
      if(m.id===currentSpeakerId){ clearInterval(speakerInterval); currentSpeakerId=null; currentSpeakerDisplay.textContent="No one speaking"; }
      members = members.filter((x)=>x.id !== m.id);
      render();
    };

    actions.append(presentBtn, speakBtn, absentBtn, removeBtn);
    li.append(name, actions);
    attendanceList.appendChild(li);

    if(m.time > 0){
      const s = document.createElement("li");
      s.innerHTML = `<span>${m.name}</span><span class="badge">${format(m.time)}</span>`;
      summaryList.appendChild(s);
    }
  });

  if(currentSpeakerId){
    syncSpeakerControls(currentSpeakerId);
  } else if(members.length){
    syncSpeakerControls(speakerSelect.value || members[0].id);
  }

  document.getElementById("totalCount").textContent = String(members.length);
  document.getElementById("presentCount").textContent = String(present);
  document.getElementById("absentCount").textContent = String(absent);
  renderQueue();
  saveState();
}

function startSessionTimer(){
  const min = Number(document.getElementById("sessionMinutes").value);
  if(!min) return;
  clearInterval(sessionInterval);
  sessionTime = min * 60;
  document.getElementById("sessionTimer").textContent = format(sessionTime);
  sessionInterval = setInterval(()=>{
    sessionTime -= 1;
    if(sessionTime <= 0) clearInterval(sessionInterval);
    document.getElementById("sessionTimer").textContent = format(Math.max(0, sessionTime));
  }, 1000);
}

function downloadCSV(){
  const rows = [["Name","Role","Attendance","SpeakingSeconds"]];
  members.forEach((m)=>rows.push([m.name, m.role, m.attendance || "", m.time]));
  const csv = rows.map((r)=>r.map((v)=>`"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "speaking-summary.csv";
  a.click();
  URL.revokeObjectURL(url);
}

function preload(){
  loadRoleConfig();
  refreshRoleLabels();

  let loaded = false;
  try{
    const data = JSON.parse(localStorage.getItem("tsm_v3_members") || "null");
    if(Array.isArray(data) && data.length){
      members = data.map((m)=>(
        {
          id: m.id || Date.now() + Math.random(),
          name: m.name || "",
          attendance: m.attendance || "",
          time: Number(m.time) || 0,
          role: m.role || "participant",
          speakLimit: Number(m.speakLimit) || ROLE_LIMITS[m.role] || ROLE_LIMITS.participant
        }
      ));
      loaded = true;
    }
  } catch(e){}

  if(!loaded){
    loadTeamSession("ALL");
  }

  renderTeamCards();
  render();
  updateProgress();
}

// events

document.getElementById("startSession").onclick = startSessionTimer;
document.getElementById("addBtn").onclick = addMember;
document.getElementById("nameInput").addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); addMember(); }
});

document.getElementById("startSpeaker").onclick = startSpeakerTimer;
document.getElementById("pauseSpeaker").onclick = ()=>clearInterval(speakerInterval);
document.getElementById("resetSpeaker").onclick = resetSpeaker;

speakerSelect.addEventListener("change", ()=>syncSpeakerControls(speakerSelect.value));

document.getElementById("updateSpeakerSettings").onclick = ()=>{
  const id = speakerSelect.value;
  const m = members.find((x)=>String(x.id) === String(id));
  if(!m) return;

  const mins = Number(customMinutes.value);
  const role = roleSelect.value;

  m.role = role;
  if(mins > 0){
    m.speakLimit = mins * 60;
  } else {
    m.speakLimit = ROLE_LIMITS[role] || 120;
    customMinutes.value = String(Math.max(1, Math.round(m.speakLimit / 60)));
  }

  if(String(currentSpeakerId) === String(m.id)){
    speakerTime = m.speakLimit;
    speakerInitial = m.speakLimit;
    speakerTimerDisplay.textContent = format(speakerTime);
    updateProgress();
  }

  saveState();
  render();
};

customMinutes.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    e.preventDefault();
    document.getElementById("updateSpeakerSettings").click();
  }
});

document.getElementById("saveRoleConfig").onclick = ()=>{
  const role = document.getElementById("roleConfigSelect").value;
  const mins = Number(document.getElementById("roleConfigMinutes").value);
  if(!mins) return;
  ROLE_LIMITS[role] = mins * 60;
  saveRoleConfig();
  refreshRoleLabels();
  members.forEach((m)=>{
    if(m.role === role){
      m.speakLimit = ROLE_LIMITS[role];
    }
  });
  if(currentSpeakerId){
    const current = members.find((m)=>m.id === currentSpeakerId);
    if(current){
      speakerTime = current.speakLimit;
      speakerInitial = current.speakLimit;
      speakerTimerDisplay.textContent = format(speakerTime);
      updateProgress();
    }
  }
  render();
};

document.getElementById("applyTeamSession").onclick = ()=>loadTeamSession(document.getElementById("teamSessionSelect").value);
document.getElementById("resetDefaultSession").onclick = ()=>{ document.getElementById("teamSessionSelect").value = "ALL"; loadTeamSession("ALL"); };
document.getElementById("downloadCSV").onclick = downloadCSV;

preload();
</script>
</body>
</html>
